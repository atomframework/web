<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Crystal Docs 0.27.0">


<link href="css/style.css" rel="stylesheet" type="text/css">

<script type="text/javascript" src="js/doc.js"></script>
<script type="text/javascript">
  CrystalDoc.base_path = "";
</script>

  <meta id="repository-name" content="github.com/onyxframework/rest">
  <title>README - github.com/onyxframework/rest</title>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header">
    <div class="search-box">
      <input type="search" class="search-input" placeholder="Search..." spellcheck="false" aria-label="Search">
    </div>

    <div class="repository-links">
      <a href="index.html">README</a>
    </div>
  </div>

  <div class="search-results" class="hidden">
    <ul class="search-list"></ul>
  </div>

  <div class="types-list">
    <ul>
  
  <li class="parent " data-id="github.com/onyxframework/rest/Atom" data-name="atom">
      <a href="Atom.html">Atom</a>
      
        <ul>
  
  <li class="parent " data-id="github.com/onyxframework/rest/Atom/Action" data-name="atom::action">
      <a href="Atom/Action.html">Action</a>
      
        <ul>
  
  <li class=" " data-id="github.com/onyxframework/rest/Atom/Action/Error" data-name="atom::action::error(code)">
      <a href="Atom/Action/Error.html">Error</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="github.com/onyxframework/rest/Atom/Channel" data-name="atom::channel">
      <a href="Atom/Channel.html">Channel</a>
      
    </li>
  
  <li class="parent " data-id="github.com/onyxframework/rest/Atom/Handlers" data-name="atom::handlers">
      <a href="Atom/Handlers.html">Handlers</a>
      
        <ul>
  
  <li class=" " data-id="github.com/onyxframework/rest/Atom/Handlers/CORS" data-name="atom::handlers::cors">
      <a href="Atom/Handlers/CORS.html">CORS</a>
      
    </li>
  
  <li class=" " data-id="github.com/onyxframework/rest/Atom/Handlers/Proc" data-name="atom::handlers::proc">
      <a href="Atom/Handlers/Proc.html">Proc</a>
      
    </li>
  
  <li class=" " data-id="github.com/onyxframework/rest/Atom/Handlers/RequestLogger" data-name="atom::handlers::requestlogger">
      <a href="Atom/Handlers/RequestLogger.html">RequestLogger</a>
      
    </li>
  
  <li class=" " data-id="github.com/onyxframework/rest/Atom/Handlers/Rescuer" data-name="atom::handlers::rescuer(t)">
      <a href="Atom/Handlers/Rescuer.html">Rescuer</a>
      
    </li>
  
  <li class="parent " data-id="github.com/onyxframework/rest/Atom/Handlers/Router" data-name="atom::handlers::router">
      <a href="Atom/Handlers/Router.html">Router</a>
      
        <ul>
  
  <li class=" " data-id="github.com/onyxframework/rest/Atom/Handlers/Router/ContextProc" data-name="atom::handlers::router::contextproc">
      <a href="Atom/Handlers/Router/ContextProc.html">ContextProc</a>
      
    </li>
  
  <li class=" " data-id="github.com/onyxframework/rest/Atom/Handlers/Router/DuplicateRouteError" data-name="atom::handlers::router::duplicaterouteerror">
      <a href="Atom/Handlers/Router/DuplicateRouteError.html">DuplicateRouteError</a>
      
    </li>
  
  <li class=" " data-id="github.com/onyxframework/rest/Atom/Handlers/Router/WebSocketProc" data-name="atom::handlers::router::websocketproc">
      <a href="Atom/Handlers/Router/WebSocketProc.html">WebSocketProc</a>
      
    </li>
  
</ul>

      
    </li>
  
</ul>

      
    </li>
  
  <li class=" " data-id="github.com/onyxframework/rest/Atom/View" data-name="atom::view">
      <a href="Atom/View.html">View</a>
      
    </li>
  
</ul>

      
    </li>
  
  <li class="parent " data-id="github.com/onyxframework/rest/HTTP" data-name="http">
      <a href="HTTP.html">HTTP</a>
      
        <ul>
  
  <li class=" " data-id="github.com/onyxframework/rest/HTTP/Request" data-name="http::request">
      <a href="HTTP/Request.html">Request</a>
      
    </li>
  
  <li class="parent " data-id="github.com/onyxframework/rest/HTTP/Server" data-name="http::server">
      <a href="HTTP/Server.html">Server</a>
      
        <ul>
  
  <li class=" " data-id="github.com/onyxframework/rest/HTTP/Server/Context" data-name="http::server::context">
      <a href="HTTP/Server/Context.html">Context</a>
      
    </li>
  
  <li class=" " data-id="github.com/onyxframework/rest/HTTP/Server/Response" data-name="http::server::response">
      <a href="HTTP/Server/Response.html">Response</a>
      
    </li>
  
</ul>

      
    </li>
  
</ul>

      
    </li>
  
</ul>

  </div>
</div>


<div class="main-content">
<h1>⚛️ Atom::Web</h1>

<p><a href="https://crystal-lang.org/" target="_blank"><img src="https://img.shields.io/badge/built%20with-crystal-000000.svg?style=flat-square" alt="Built with Crystal"/></a>
<a href="https://travis-ci.org/atomframework/web" target="_blank"><img src="https://img.shields.io/travis/atomframework/web/master.svg?style=flat-square" alt="Build status"/></a>
<a href="https://atomframework.github.io/web/" target="_blank"><img src="https://img.shields.io/badge/docs-available-brightgreen.svg?style=flat-square" alt="Docs"/></a>
<a href="https://github.com/atomframework/web/releases" target="_blank"><img src="https://img.shields.io/github/release/atomframework/web.svg?style=flat-square" alt="Releases"/></a>
<a href="https://github.com/veelenga/awesome-crystal" target="_blank"><img src="https://github.com/vladfaust/awesome/blob/badge-flat-alternative/media/badge-flat-alternative.svg" alt="Awesome"/></a>
<a href="https://vladfaust.com" target="_blank"><img src="https://img.shields.io/badge/style-.com-lightgrey.svg?longCache=true&style=flat-square&label=vladfaust&colorB=0a83d8" alt="vladfaust.com"/></a>
<a href="https://www.patreon.com/vladfaust" target="_blank"><img src="https://img.shields.io/badge/dynamic/json.svg?label=patrons&url=https://www.patreon.com/api/user/11296360&query=$.included[0].attributes.patron_count&style=flat-square&colorB=red&maxAge=86400" alt="Patrons count"/></a></p>

<p>A collection of HTTP components for building Action-View-oriented frameworks. Used in <a href="https://github.com/atomframework/atom" target="_blank">Atom Framework</a>.</p>

<p><a href="https://www.patreon.com/vladfaust" target="_blank"><img src="https://vladfaust.com/img/patreon-small.svg" alt="Become Patron"/></a></p>

<h2>Installation</h2>

<p>Add this to your application's <code>shard.yml</code>:</p>

<pre><code class="language-yaml">dependencies:
  atom-web:
    github: atomframework/web
    version: ~> 0.5.0</code></pre>

<p>This shard follows <a href="http://semver.org/" target="_blank">Semantic Versioning v2.0.0</a>, so check <a href="https://github.com/atomframework/web/releases" target="_blank">releases</a> and change the <code>version</code> accordingly.</p>

<h2>Included components</h2>

<ul><li><a href="https://atomframework.github.io/web/Atom/Web/Action.html" target="_blank">Action</a> - ensapsulates logic</li><li><a href="https://atomframework.github.io/web/Atom/Web/View.html" target="_blank">View</a> - responsible for rendering</li><li><a href="https://atomframework.github.io/web/Atom/Web/Channel.html" target="_blank">Channel</a> - convenient websockets wrapper</li><li>Handlers</li><ul><li><a href="https://atomframework.github.io/web/Atom/Web/Handlers/CORS.html" target="_blank">CORS</a> - handles <a href="https://en.wikipedia.org/wiki/Cross-origin_resource_sharing" target="_blank">CORS</a></li><li><a href="https://atomframework.github.io/web/Atom/Web/Handlers/Proc.html" target="_blank">Proc</a> - calls a proc on each call</li><li><a href="https://atomframework.github.io/web/Atom/Web/Handlers/RequestLogger.html" target="_blank">RequestLogger</a> - colorfully logs requests</li><li><a href="https://atomframework.github.io/web/Atom/Web/Handlers/Rescuer.html" target="_blank">Rescuer</a> - rescues errors</li><li><a href="https://atomframework.github.io/web/Atom/Web/Handlers/Router.html" target="_blank">Router</a> - routes requests</li></ul></ul>

<h2>Usage</h2>

<ul><li><a href="#without-atom" target="_blank">Without Atom</a></li><ul><li><a href="#basic-example" target="_blank">Basic example</a></li><li><a href="#simple-json-api-example" target="_blank">Simple JSON API example</a></li><li><a href="#websockets-example" target="_blank">Websockets</a></li></ul></ul>

<h3>Without <a href="https://github.com/atomframework/atom" target="_blank">Atom</a></h3>

<p><a href="https://github.com/atomframework/atom" target="_blank">Atom</a> reduces overall code by wrapping common scenarios into macros, so the code below is quite verbose.</p>

<h4>Basic example</h4>

<pre><code class="language-crystal"><span class="k">require</span> <span class="s">&quot;atom-web&quot;</span>

record <span class="t">User</span>, id : <span class="t">Int32</span>, name : <span class="t">String</span>

<span class="t">Users</span> <span class="o">=</span> {<span class="n">1</span> => <span class="t">User</span>.<span class="k">new</span>(<span class="n">1</span>, <span class="s">&quot;John&quot;</span>)}

<span class="k">struct</span> <span class="t">Actions</span><span class="t">::</span><span class="t">GetUser</span>
  <span class="k">include</span> <span class="t">Atom</span><span class="t">::</span><span class="t">Action</span>

  params <span class="k">do</span>
    <span class="k">type</span> id : <span class="t">Int32</span>
  <span class="k">end</span>

  errors <span class="k">do</span>
    <span class="k">type</span> <span class="t">UserNotFound</span>(<span class="n">404</span>)
  <span class="k">end</span>

  <span class="k">def</span> <span class="m">call</span>
    user <span class="o">=</span> <span class="t">Users</span>[params.id]? || raise <span class="t">UserNotFound</span>.<span class="k">new</span>
    <span class="k">return</span> <span class="t">Views</span><span class="t">::</span><span class="t">User</span>.<span class="k">new</span>(user)
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">struct</span> <span class="t">Views</span><span class="t">::</span><span class="t">User</span>
  <span class="k">include</span> <span class="t">Atom</span><span class="t">::</span><span class="t">View</span>

  <span class="k">def</span> <span class="m">initialize</span>(@user : <span class="t">::</span><span class="t">User</span>)
  <span class="k">end</span>

  <span class="k">def</span> <span class="m">to_s</span>(io)
    io <span class="o">&lt;&lt;</span> <span class="s">&quot;id: </span><span class="i">#{</span>@user.id<span class="i">}</span><span class="s">, name: </span><span class="i">#{</span>@user.name<span class="i">}</span><span class="s">\n&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>

logger <span class="o">=</span> <span class="t">Logger</span>.<span class="k">new</span>(<span class="t">STDOUT</span>, <span class="t">Logger</span><span class="t">::</span><span class="t">DEBUG</span>)
request_logger <span class="o">=</span> <span class="t">Atom</span><span class="t">::</span><span class="t">Handlers</span><span class="t">::</span><span class="t">RequestLogger</span>.<span class="k">new</span>(logger)

router <span class="o">=</span> <span class="t">Atom</span><span class="t">::</span><span class="t">Handlers</span><span class="t">::</span><span class="t">Router</span>.<span class="k">new</span> <span class="k">do</span>
  get <span class="s">&quot;/users/:id&quot;</span>, <span class="t">Actions</span><span class="t">::</span><span class="t">GetUser</span>
<span class="k">end</span>

server <span class="o">=</span> <span class="t">HTTP</span><span class="t">::</span><span class="t">Server</span>.<span class="k">new</span>([request_logger, router]) <span class="k">do</span> <span class="o">|</span>context<span class="o">|</span>
  <span class="k">if</span> proc <span class="o">=</span> context.proc
    proc.call(context)

    <span class="k">if</span> error <span class="o">=</span> context.response.error
      <span class="k">case</span> error
      <span class="k">when</span> <span class="t">Params</span><span class="t">::</span><span class="t">Error</span>
        code <span class="o">=</span> <span class="n">400</span>
        message <span class="o">=</span> error.message
      <span class="k">when</span> <span class="t">Atom</span><span class="t">::</span><span class="t">Action</span><span class="t">::</span><span class="t">Error</span>
        code <span class="o">=</span> error.code
        message <span class="o">=</span> error.<span class="k">class</span>.name
      <span class="k">else</span>
        code <span class="o">=</span> <span class="n">500</span>
        message <span class="o">=</span> error.message
      <span class="k">end</span>

      context.response.respond_with_error(message, code)
    <span class="k">elsif</span> view <span class="o">=</span> context.response.view
      context.response.print(view)
    <span class="k">end</span>
  <span class="k">else</span>
    context.response.respond_with_error(<span class="s">&quot;Route Not Found: </span><span class="i">#{</span>context.request.path<span class="i">}</span><span class="s">&quot;</span>, <span class="n">404</span>)
  <span class="k">end</span>
<span class="k">end</span>

server.bind_tcp(<span class="n">5000</span>)
logger.info(<span class="s">&quot;Listening at http://</span><span class="i">#{</span>server.addresses.first<span class="i">}</span><span class="s">&quot;</span>)
server.listen

<span class="c"># I,  INFO -- : Listening at http://127.0.0.1:5000</span>
<span class="c"># D, DEBUG -- :     GET /users/1 200 139μs</span>
<span class="c"># D, DEBUG -- :     GET /users/2 404 197μs</span>
<span class="c"># D, DEBUG -- :     GET /users/foo 400 623μs</span>
<span class="c"># D, DEBUG -- :     GET /user 404 111μs</span></code></pre>

<pre><code class="language-shell">$ curl http://127.0.0.1:5000/users/1
id: 1, name: John
$ curl http://127.0.0.1:5000/users/2
404 Actions::GetUser::UserNotFound
$ curl http://127.0.0.1:5000/users/foo
400 Couldn't cast parameter `id` from `String` to `Int32`
$ curl http://127.0.0.1:5000/user
404 Route Not Found: /user</code></pre>

<h4>Simple JSON API example</h4>

<p>In this example, an application always returns formatted JSON responses.</p>

<pre><code class="language-crystal"><span class="k">require</span> <span class="s">&quot;atom-web&quot;</span>

record <span class="t">User</span>, id : <span class="t">Int32</span>, name : <span class="t">String</span>

<span class="t">Users</span> <span class="o">=</span> {<span class="n">1</span> => <span class="t">User</span>.<span class="k">new</span>(<span class="n">1</span>, <span class="s">&quot;John&quot;</span>)}

<span class="k">struct</span> <span class="t">Actions</span><span class="t">::</span><span class="t">GetUser</span>
  <span class="k">include</span> <span class="t">Atom</span><span class="t">::</span><span class="t">Action</span>

  params <span class="k">do</span>
    <span class="k">type</span> id : <span class="t">Int32</span>
  <span class="k">end</span>

  errors <span class="k">do</span>
    <span class="k">type</span> <span class="t">UserNotFound</span>(<span class="n">404</span>), id : <span class="t">Int32</span> <span class="k">do</span>
      <span class="k">super</span> <span class="s">&quot;User not found with id </span><span class="i">#{</span>id<span class="i">}</span><span class="s">&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="m">call</span>
    user <span class="o">=</span> <span class="t">Users</span>[params.id]? || raise <span class="t">UserNotFound</span>.<span class="k">new</span>(params.id)
    <span class="k">return</span> <span class="t">Views</span><span class="t">::</span><span class="t">User</span>.<span class="k">new</span>(user)
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">struct</span> <span class="t">Views</span><span class="t">::</span><span class="t">User</span>
  <span class="k">include</span> <span class="t">Atom</span><span class="t">::</span><span class="t">View</span>

  <span class="k">def</span> <span class="m">initialize</span>(@user : <span class="t">::</span><span class="t">User</span>)
  <span class="k">end</span>

  <span class="k">def</span> <span class="m">to_json</span>(json)
    {id: @user.id, name: @user.name}.to_json(json)
  <span class="k">end</span>
<span class="k">end</span>

router <span class="o">=</span> <span class="t">Atom</span><span class="t">::</span><span class="t">Handlers</span><span class="t">::</span><span class="t">Router</span>.<span class="k">new</span> <span class="k">do</span>
  get <span class="s">&quot;/users/:id&quot;</span>, <span class="t">Actions</span><span class="t">::</span><span class="t">GetUser</span>
<span class="k">end</span>

server <span class="o">=</span> <span class="t">HTTP</span><span class="t">::</span><span class="t">Server</span>.<span class="k">new</span>([router]) <span class="k">do</span> <span class="o">|</span>context<span class="o">|</span>
  <span class="k">if</span> proc <span class="o">=</span> context.proc
    proc.call(context)

    <span class="k">if</span> context.response.error || context.response.view
      json <span class="o">=</span> <span class="t">JSON</span><span class="t">::</span><span class="t">Builder</span>.<span class="k">new</span>(context.response.output)
      context.response.content_type <span class="o">=</span> <span class="s">&quot;application/json&quot;</span>

      json.document <span class="k">do</span>
        <span class="k">if</span> error <span class="o">=</span> context.response.error
          message <span class="o">=</span> error.message
          payload <span class="o">=</span> <span class="n">nil</span>

          <span class="k">case</span> error
          <span class="k">when</span> <span class="t">Params</span><span class="t">::</span><span class="t">TypeCastError</span>
            code <span class="o">=</span> <span class="n">400</span>
            payload <span class="o">=</span> {parameter: error.pretty_path, expectedType: error.target, actualType: error.source}
          <span class="k">when</span> <span class="t">Params</span><span class="t">::</span><span class="t">MissingError</span>
            code <span class="o">=</span> <span class="n">400</span>
            payload <span class="o">=</span> {parameter: error.pretty_path}
          <span class="k">when</span> <span class="t">Params</span><span class="t">::</span><span class="t">Error</span>
            code <span class="o">=</span> <span class="n">400</span>
          <span class="k">when</span> <span class="t">Atom</span><span class="t">::</span><span class="t">Action</span><span class="t">::</span><span class="t">Error</span>
            code <span class="o">=</span> error.code
            payload <span class="o">=</span> error.payload
          <span class="k">else</span> code <span class="o">=</span> <span class="n">500</span>
          <span class="k">end</span>

          context.response.status_code <span class="o">=</span> code

          {
            success: <span class="n">false</span>,
            error:   {
              name:    error.<span class="k">class</span>.name.split(<span class="s">&quot;::&quot;</span>).last,
              message: message,
              payload: payload,
            },
          }.to_json(json)
        <span class="k">elsif</span> view <span class="o">=</span> context.response.view
          {
            success: <span class="n">true</span>,
            data:    view,
          }.to_json(json)
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">else</span>
    json <span class="o">=</span> <span class="t">JSON</span><span class="t">::</span><span class="t">Builder</span>.<span class="k">new</span>(context.response.output)
    context.response.content_type <span class="o">=</span> <span class="s">&quot;application/json&quot;</span>
    context.response.status_code <span class="o">=</span> <span class="n">404</span>

    json.document <span class="k">do</span>
      {
        success: <span class="n">false</span>,
        error:   {
          name:    <span class="s">&quot;RouteNotFound&quot;</span>,
          message: <span class="s">&quot;Route not found: </span><span class="i">#{</span>context.request.path<span class="i">}</span><span class="s">&quot;</span>,
          payload: {
            path: context.request.path,
          },
        },
      }.to_json(json)
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

server.bind_tcp(<span class="n">5000</span>)
puts <span class="s">&quot;Listening at http://</span><span class="i">#{</span>server.addresses.first<span class="i">}</span><span class="s">&quot;</span>
server.listen</code></pre>

<pre><code class="language-shell">$ curl http://127.0.0.1:5000/users/1
{"success":true,"data":{"id":1,"name":"John"}}
$ curl http://127.0.0.1:5000/users/2
{"success":false,"error":{"name":"UserNotFound","message":"User not found with id 2","payload":{"id":2}}}
$ curl http://127.0.0.1:5000/users/foo
{"success":false,"error":{"name":"TypeCastError","message":"Couldn't cast parameter `id` from `String` to `Int32`","payload":{"parameter":"id","expectedType":"Int32","actualType":"String"}}}
$ curl http://127.0.0.1:5000/user
{"success":false,"error":{"name":"RouteNotFound","message":"Route not found: /user","payload":{"path":"/user"}}}</code></pre>

<h4>Websockets example</h4>

<p>We call them <em>Channels</em> for convenience.</p>

<pre><code class="language-crystal"><span class="k">require</span> <span class="s">&quot;atom-web&quot;</span>

<span class="k">class</span> <span class="t">Notifications</span>
  <span class="k">include</span> <span class="t">Atom</span><span class="t">::</span><span class="t">Channel</span>

  @@subscriptions <span class="o">=</span> <span class="t">Array</span>(<span class="k">self</span>).<span class="k">new</span>

  <span class="k">def</span> <span class="m">self</span>.notify(message)
    @@subscriptions.each <span class="o">&amp;</span>.socket.send(message)
  <span class="k">end</span>

  <span class="k">def</span> <span class="m">on_open</span>
    socket.send(<span class="s">&quot;Hello&quot;</span>)
    @@subscriptions.push(<span class="k">self</span>)
  <span class="k">end</span>

  <span class="k">def</span> <span class="m">on_close</span>
    @@subscriptions.delete(<span class="k">self</span>)
  <span class="k">end</span>
<span class="k">end</span>

router <span class="o">=</span> <span class="t">Atom</span><span class="t">::</span><span class="t">Handlers</span><span class="t">::</span><span class="t">Router</span>.<span class="k">new</span> <span class="k">do</span>
  ws <span class="s">&quot;/notifications&quot;</span> <span class="k">do</span> <span class="o">|</span>socket, env<span class="o">|</span>
    <span class="t">Notifications</span>.subscribe(socket, env)
  <span class="k">end</span>
<span class="k">end</span>

<span class="c"># Later in the code...</span>

<span class="t">Notifications</span>.notify(<span class="s">&quot;Something happened!&quot;</span>) <span class="c"># Will notify all subscribers binded to this particular Crystal process</span></code></pre>

<h2>Contributing</h2>

<ol><li>Fork it ( https://github.com/atomframework/web/fork )</li><li>Create your feature branch (git checkout -b my-new-feature)</li><li>Commit your changes (git commit -am 'Add some feature')</li><li>Push to the branch (git push origin my-new-feature)</li><li>Create a new Pull Request</li></ol>

<h2>Contributors</h2>

<ul><li><a href="https://github.com/vladfaust" target="_blank">@vladfaust</a> Vlad Faust - creator, maintainer</li></ul>
</div>
</body>
</html>
